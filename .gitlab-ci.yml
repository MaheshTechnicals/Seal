stages:
  - build

variables:
  # Speed up Gradle
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

build_job:
  stage: build
  image: mobiledevops/android-sdk-image:34.0.0-jdk17

  before_script:
    # 1. Install Java 21 (Since your GitHub used JDK 21) & jq (for reading release.json)
    - apt-get update && apt-get install -y openjdk-21-jdk jq
    - export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
    
    # 2. Decode the Keystore (Using your exact variable name: ANDROID_SIGNING_KEY)
    - echo "$ANDROID_SIGNING_KEY" | base64 -d > "$CI_PROJECT_DIR/Mahesh.jks"
    - chmod +x ./gradlew

  script:
    # --- STEP 1: EXTRACT VERSION ---
    - |
      VERSION=$(grep -A 1 'val currentVersion: Version =' buildSrc/src/main/kotlin/Version.kt | grep -oP 'versionMajor = \K\d+' | head -1).$(grep -A 1 'val currentVersion: Version =' buildSrc/src/main/kotlin/Version.kt | grep -oP 'versionMinor = \K\d+' | head -1).$(grep -A 1 'val currentVersion: Version =' buildSrc/src/main/kotlin/Version.kt | grep -oP 'versionPatch = \K\d+' | head -1)
      echo "ðŸš€ Building Version: $VERSION"

    # --- STEP 2: CHECK RELEASE CONFIG ---
    - |
      SHOULD_RELEASE=$(jq -r '.release' release.json)
      echo "Release Status: $SHOULD_RELEASE"

    # --- STEP 3: BUILD & SIGN (Using Gradle Injection) ---
    # We build the 'release' variant and pass the keys directly
    - ./gradlew assembleRelease \
        -Pandroid.injected.signing.store.file="$CI_PROJECT_DIR/Mahesh.jks" \
        -Pandroid.injected.signing.store.password="$ANDROID_KEYSTORE_PASSWORD" \
        -Pandroid.injected.signing.key.alias="$ANDROID_ALIAS" \
        -Pandroid.injected.signing.key.password="$ANDROID_KEY_PASSWORD"

    # --- STEP 4: ORGANIZE ARTIFACTS ---
    # Move the signed APK to a clean folder so it's easy to download
    - mkdir -p release_output
    - mv app/build/outputs/apk/release/*.apk release_output/
    - echo "âœ… Build and Sign Complete. APKs are in release_output folder."

  artifacts:
    name: "SealPlus-$CI_COMMIT_SHORT_SHA"
    paths:
      - release_output/*.apk
    expire_in: 1 week